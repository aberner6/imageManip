
<html>

<head>
    <title>Prep</title>
</head>
<style>
	rect.backround{
		display:block;
	}
	.brush .extent {
		stroke: gray;
		fill: dodgerblue;
		fill-opacity: .365;
		display:block;
	}
	#click{
		background-color: gray;
		width:20px;
		color:white;
		padding:2px;
	}
</style>
<body>
    <script src="d3.min.js" charset="utf-8"></script>
    <script src="http://cdn.jsdelivr.net/sparkjs/0.4.2/spark.min.js"></script>
    <script src="jquery.min.js"></script>
    <div id="click">up</div>
<script type="text/javascript">
var items = [
{"component": 1, "start": 1439308645000, "end": 1439308645000+44762800},
{"component": 2, "start": 1440156273000-100000000, "end": 1440156273000},
{"component": 3, "start": 1440156273000-80000000, "end": 1440156273000},
]
$("#click").click(function(){
	updateData();
})

// Timestamp,Device,button,overview,screenshot
var entry1 = [];
var prepped = false;

// 15:00:07-314093466_12-08-2015
var parseDate = d3.time.format('%X_%d-%m-%Y').parse;
var mindate;
var maxdate = "Fri Aug 01 2015 13:24:33 GMT+0200 (CEST)";

var uniques = [];
// var uniques2 = [];

var totalPhotos = [];

var m = [20, 15, 15, 120], //top right bottom left
	w = 960, //- m[1] - m[3],
	h = 500 - m[0] - m[2],
	miniHeight = 10,
	mainHeight = 300;

//scales
var x = d3.scale.linear()
		.range([0, w]);
var x1 = d3.scale.linear()
		.range([0, w-m[1]]);	
var oColor = d3.scale.ordinal()
	.domain([d3.range(10)])
    .range(["#16CEC5","#96CEB4", "#ADB3FF", "#FFEEAD"]);

var chart = d3.select("body")
			.append("svg")
			.attr("width", w + m[1] + m[3])
			.attr("height", h + m[0] + m[2])
			.attr("class", "chart");

chart.append("defs").append("clipPath")
	.attr("id", "clip")
	.append("rect")
	.attr("width", w)
	.attr("height", mainHeight);

var main = chart.append("g")
			.attr("transform", "translate(" + m[3] + "," + m[0] + ")")
			.attr("width", w)
			.attr("height", mainHeight)
			.attr("class", "main");

var mini = chart.append("g")
			.attr("transform", "translate(" + m[3] + "," + (mainHeight + m[0]) + ")")
			.attr("width", w)
			.attr("height", miniHeight)
			.attr("class", "mini");


var itemRectz = main.append("g")
					.attr("clip-path", "url(#clip)");

var itemRects = main.append("g")
					.attr("clip-path", "url(#clip)");

var itemCircs = main.append("g")
					.attr("clip-path", "url(#clip)");
// setInterval(function() {
// 	var e = [mindate, +mindate+3600000]; //set brush range
// 	brush.extent(e);    
// 	mini.call(brush);  
// }, 30000);


	getData();

var uniques1, uniques2;
// , uniques3;
function getData(){
	d3.csv("https://dl.dropboxusercontent.com/s/h1zyddyuicbn134/db?dl=0", function(error, data) {
		console.log(parseDate(data[data.length-1]['Timestamp']));
		for (var i= 0; i<data.length; i++){
		// console.log(data[i]['Device'])
		    if (data[i]['Device'] == "420038000547343232363230") {  
		    	entry1.push({
		            "buttonIs": data[i]['button'],
		            "timeIs": parseDate(data[i]['Timestamp']),
		            "photO": data[i]['overview'],
		            "photS": data[i]['screenshot']
		        })
		    }
		}
		uniques1 = unique(entry1);
		if(uniques1.length>0){
			console.log(uniques1.length);
			prepScales();
			console.log("prepped")
			prepped = true;
		}
		// console.log(entry1[entry1.length-1].timeIs)
	})
}

var i = 0;
var entry2 = [];
function updateData() {
	d3.csv("https://dl.dropboxusercontent.com/s/h1zyddyuicbn134/db?dl=0", function(error, data) {
		for (var i= 0; i<data.length; i++){
		    if (data[i]['Device'] == "420038000547343232363230") {  
		    	entry2.push({
		            "buttonIs": data[i]['button'],
		            "timeIs": parseDate(data[i]['Timestamp']),
		            "photO": data[i]['overview'],
		            "photS": data[i]['screenshot']
		        })
		    }
		}
		uniques1 = unique(entry2);
	})
}


var index = 0;
if(prepped){
	var autoMove = setInterval(function() {
		var e = [mindate, +mindate+3600000*index]; //set brush range
		brush.extent(e);    
		mini.call(brush);  
	}, 30000);
	index++;
	console.log(index);	
	if((+mindate+3600000*index)>= maxdate){
		//then stop interval
		console.log("stopping interval")
	}
}








$(window).keypress(function(e) {
  if (e.keyCode === 0 || e.keyCode === 32) {
    console.log('Space pressed');
    prepScales();
  }
});

var brush = d3.svg.brush()
function prepScales(){
	console.log("in prep scales")
	console.log(uniques1.length)
    mindate = uniques1[1].timeIs;
    maxdate = uniques1[uniques1.length - 1].timeIs;

	// for (j = 0; j <= 24; j++) {
	//     totalPhotos[j] = photoConsolidation(j)
	// }

	x.domain([mindate, maxdate])

	//brush
	brush
	.x(x)
	.on("brush", display);

	mini.append("g")
	.attr("class", "x brush")
	.call(brush)
	.selectAll("rect")
	.attr("y", 1)
	.attr("stroke","none")
	.attr("fill","lightgrey")
	.style("visibility", "visible")
	.attr("height", miniHeight - 1);



	//mini item lines
	mini.append("g").selectAll(".linie")
	.data(uniques1)
	.enter().append("line")
	.attr("class", "linie")
	.attr("x1", function(d) {return x(d.timeIs);})
	.attr("x2", function(d) {return x(d.timeIs);})
	.attr("y1", 10)
	.attr("y2", 15)
	.attr("stroke","grey")
	.attr("opacity",.5);


	//mini item rects
	// mini.append("g").selectAll("miniItems")
	// .data(uniques)
	// .enter().append("image")
	// .attr("class", function(d) {return "miniItem" + d.timeIs;})
	// .attr("x", function(d) {return x(d.timeIs);})
	// .attr("y", 200)
	// .attr("width", 20)
	// .attr("height", 20)
	// .attr("xlink:href", function(d, i) {
	//         if (d.buttonIs == "button3") { //1 is bad 3 is good
	//             return "idea.png";
	//         }
	// });
	
	//mini item circles
	// mini.append("g").selectAll("circles")
	// .data(uniques)
	// .enter().append("circle")
	// .attr("class", function(d) {return "circles" + d.timeIs;})
	// .attr("cx", function(d) {return x(d.timeIs);})
	// .attr("cy", 100)
	// .attr("r",5);

	//mini item rects
	// mini.append("g").selectAll("miniItemz")
	// 	.data(items)
	// 	.enter().append("rect")
	// 	.attr("class", function(d) {return "miniItemz" + d.lane;})
	// 	.attr("x", function(d) {return x(d.start);})
	// 	.attr("y", function(d) {return y2(d.lane + .5) - 5;})
	// 	.attr("width", function(d) {return x(d.end - d.start);})
	// 	.attr("height", 10);
	display();
}


var rects;
function display() {

	// var rects, 
	var circs, rectz,
		minExtent = brush.extent()[0],
		maxExtent = brush.extent()[1],
		visItems = uniques1.filter(function(d) {return d.timeIs < maxExtent && d.timeIs > minExtent;});

		vizItems = items.filter(function(d) {return d.start < maxExtent && d.end > minExtent;}); 

	mini.select(".brush")
		.call(brush.extent([minExtent, maxExtent]));

	x1.domain([minExtent, maxExtent]);
	console.log(maxExtent);
	console.log(maxdate);
///////////////////////////////
			rectz = itemRectz.selectAll("rect")
			        .data(vizItems)
					.attr("x", function(d) {
						return x1(d.start);
					})
					.attr("width", function(d) {
						return x1(d.end) - x1(d.start);
					});
			rectz.enter().append("rect")
				.attr("class", function(d) {
					return "miniItemz" + d.component;
				})
				.attr("x", function(d) {
					return x1(d.start);
				})
				.attr("y", function(d){
					return d.component*20+50;
				})
				.attr("width", function(d) {
					return x1(d.end) - x1(d.start);
				})
				.attr("height", 5)
				.attr("fill",function(d){
					console.log(d.component)
					return oColor(d.component);
				})
			rectz.exit().remove();
///////////////////////////////



///////////////////////////////
	rects = itemRects.selectAll("image")
	        .data(visItems)
		.attr("x", function(d) {return x1(d.timeIs);})
		.attr("width", 20);

	rects.enter().append("image")
		.attr("class", function(d) {return "miniItem" + d.timeIs;})
         .attr("xlink:href", function(d, i) {
                if (d.buttonIs == "button3") { //1 is bad 3 is good
                    return "idea.png";
                }
            })
		.attr("x", function(d) {return x1(d.timeIs);})
		.attr("y", 200)
		.attr("width", 20)
		.attr("height", 20)
		.attr("opacity",.5);
	rects.exit().remove();
///////////////////////////////



// ///////////////////////////////
// 	circs = itemCircs.selectAll("circle")
// 	        .data(visItems)
// 		.attr("cx", function(d) {
// 			return x1(d.timeIs);
// 		})
// 		.attr("r", 2);	

// 	circs.enter().append("circle")
// 		.attr("class", function(d) {return "circles" + d.timeIs;})
// 		.attr("cx", function(d) {return x1(d.timeIs);})
// 		.attr("cy", 150)
// 		.attr("r",2)
// 		.attr("fill","blue")
// 		.attr("opacity",.5);
// 	circs.exit().remove();
// ///////////////////////////////
}





function getUnique(inputArray){
	var outputArray = [];
	for (var i = 0; i<inputArray.length; i++){
		if(jQuery.inArray(inputArray[i], outputArray)==-1)
		{
			outputArray.push(inputArray[i]);
		}
	}
	return outputArray;
}


function unique(obj) {
    var uniques = [];
    var stringify = {};
    for (var i = 0; i < obj.length; i++) {
        var keys = Object.keys(obj[i]);
        keys.sort(function(a, b) {
            return a - b
        });
        var str = '';
        for (var j = 0; j < keys.length; j++) {
            str += JSON.stringify(keys[j]);
            str += JSON.stringify(obj[i][keys[j]]);
        }
        if (!stringify.hasOwnProperty(str)) {
            uniques.push(obj[i]);
            stringify[str] = true;
        }
    }
    return uniques;
}
function photoConsolidation(index) {
    var total = 0;
    for (i = 0; i < uniques.length; i++) {
        if (uniques[i].timeIs.getHours() == index) {
            total++;
        } else {}
    }
    return total;
}
</script>
</body>
</html>